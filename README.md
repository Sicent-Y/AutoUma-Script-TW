# AutoUma-Script-TW

赛马娘凹种马根本不是人干的事，由于没有找到免费的、手机版、繁中服的自动化脚本，遂自己动手编写了一个超级简陋的。

# 功能

- 该脚本**单次运行**只能进行一次**单轮育成**。
- 进入育成后，脚本将自动读取训练、状态，自动选择训练、休息、外出或前往比赛，循环执行78个回合完成一轮育成
- 脚本使用**adb**进行操作，需要用电脑连接手机，控制手机自动游玩赛马娘游戏；adb连接的该设备**不应**被操作、打断(包括弹出通知、切换屏幕),**否则将会卡死** *详细内容见后*
- 代码识别范围狭窄，**不能够**自动选择剧本、培育马娘、种马与支援卡。请手动操作，将页面导航至**开始育成前的最后一步**再运行代码(也就是确认支援卡后，弹出的确认开始育成弹窗，确保体力足够进行一次育成；此时再运行代码，**否则将会卡死** *详细内容见后*)
- 代码运行将在育成完成获取技能的界面处**结束**，之后需要手动查收；代码执行完成后会自动让手机熄屏
- 具体使用方法，会在后面的使用方法里介绍

# 原理

- 通过adb连接手机，截取手机屏幕进行判断，随后模拟点击
- 通过`opencv`库的`matchtemplate`函数进行模板匹配，通过访问`source\data\`文件夹内存储的模板图像，匹配手机截屏，以此判断页面、训练信息、按钮位置等
  - 注意：模板匹配对分辨率敏感，该脚本在1080x2400分辨率下开发，请确保你的设备分辨率一致，否则将会卡死 *详细内容见后*
- 每一回合会根据获取的信息，按照一定的算法，计算各项操作的权重，最后选取权重最高者执行(休息、外出、保健室、五种训练、比赛)
  
# 配置环境

开始环境配置前，请确保如下条件
> 安装Python>=3.8
> 
> 安装Git
> 
> 闲置的、支持adb的Android手机
>
> Android端繁中服赛马娘
> 
> 正确的网络连接

### 安装脚本运行环境

#### 克隆GitHub仓库

在你的目录下打开cmd，输入如下内容克隆仓库 *注:是在指定目录下打开cmd，操作方法请自己搜索*
```
git clone https://github.com/Sicent-Y/AutoUma-Script-TW
```

运行完成后，会在你的目录下创建一个AutoUma-Script-TW文件夹，该文件夹即项目文件夹

#### 创建python虚拟环境

进入AutoUma-Script-TW文件夹，在该目录下重新打开cmd；或者你也可以不关闭刚才打开的cmd窗口，输入`cd AutoUma-Script-TW`进入AutoUma-Script-TW目录

输入如下代码创建虚拟环境
```
python -m venv AutoUma
```

进入虚拟环境
```
.\AutoUma\Scripts\activate.bat
```

安装依赖
```
pip install -r requirements.txt
```

这可能需要一些时间，你可以使用国内镜像源，这样会快一些`pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple`

### 配置adb

#### 安装adb

*该仓库自带有adb工具包，无需额外手动下载。当然你也可以根据网络教程手动安装adb并设置系统变量*

你可以在AutoUma-Script-TW文件夹根目录下找到platform-tools文件夹，这就是adb工具；接下来需要将其添加到系统变量，从而使得我们能够使用adb
- 右键点击win菜单键(屏幕左下角的那个)
- 选择`系统`
- 点击`高级系统设置`
- 点击`环境变量`
- 在`系统变量`框中找到`Path`，选择到`Path`点击下方的`编辑`
- 点击`新建`
- 输入platform-tools文件夹的路径，如`D:\Github\AutoUma-Scripts-TW\platform-tools`
- `确认`以保存设置

#### 连接你的设备

使用数据线连接你的手机与电脑，确保你的数据线与接口能够传输数据；过于低级的数据线可能只能充电而无法起到连接手机电脑的作用；另外，为了防止意料外的问题，请将手机自动熄屏时间调至10分钟或者永不熄屏

#### 手机adb设置

找到你的手机，打开开发者选项

进入`设置->开发者选项`，找到`USB调试`或`ADB设置`，该部分不同手机并不完全相同，请自行完成操作，允许你的电脑使用adb操作你的手机；或者自行搜索网络教程

  - 注:由于未知bug，脚本**不支持**无线adb连接，请不要尝试使用无线adb连接
 
在项目文件夹下打开cmd，可以通过`adb devices`确认是否连接成功

#### 设置分辨率

该脚本只能在指定的分辨率下运行，需要将分辨率设置为1080x2400，density为420，在项目文件夹下打开cmd
```
adb shell wm size 1080x2400
adb shell wm density 420
```

设置完成后，你的手机屏幕可能会变得有点抽象，不必担心，你可以在脚本使用完成后，通过如下命令重置屏幕
```
adb shell wm size reset
adb shell wm density reset
```

同样，你可能会出现屏幕无法点击的问题，如下命令可能可以帮助你
```
adb shell input tap X Y   点击屏幕(X,Y)像素处 
adb shell input swipe X1 Y1 X2 Y2 T   在T秒内滑动屏幕,从(X1,Y1)到(X2,Y2)
adb shell input keyevent 82   唤起菜单/切后台
```

# 使用方法

在AutoUma-Script-TW文件夹根目录下打开cmd，进入你创建的虚拟环境
```
.\AutoUma\Scripts\activate.bat
```

确认adb连接正常、且手机界面位于指定位置后，输入以下命令，即可执行脚本
```
python main.py
```

### 脚本适用范围与指定页面

请在输入上述命令开始执行脚本前，确保你的手机已经打开了赛马娘，并使你的屏幕处在如下界面

<img src="https://img1.imgtp.com/2023/04/10/msbDBj5C.jpg" width="30%">

脚本运行后，会自动点击`开始培育！`，随后进入育成页面。 *注：如果你不小心在启动脚本前就点到了`开始培育！`，其实这无所谓，在进入育成主界面前，随时都可以启动脚本，脚本有能力自动识别*

接下来脚本将会持续运行，直到育成结束，抵达如下界面，抵达此界面后脚本将自动关闭，运行结束，并使手机熄屏

<img src="https://img1.imgtp.com/2023/04/10/1OGeY49p.jpg" width="30%">

**注：** 启动脚本时，请确保你的体力充足，防止出现如下界面；如果你希望使用双倍体力，请自己勾上双倍选项后再启动脚本，并确保体力足够

<img src="https://img1.imgtp.com/2023/04/10/cKNkUG29.jpg" width="30%">

**注：** 脚本目前仅支持URA剧本的育成，并且单次执行只能进行一次育成，不能够连续多次执行(因为需要人工选择种马与支援卡)；脚本将会停在结束确认的界面，请手动前往获取技能

### 自定义参数与适应性调整

由于不同的马娘属性加成不同、使用的种马、支援卡不一样，这些区别会显著影响育成属性的加点选择，因此脚本提供个性化设置功能，可以设置育成回合每一阶段的属性目标、设置目标赛事等；这些参数储存在`config.yaml`文件内，在需要时，请手动打开文件进行修改

接下来将介绍`config.yaml`内的详细内容

#### Device

填写你想连接的设备，填写auto则为自动选择

#### DevicesList

空参数，在脚本运行中不起作用，给你提供一个记录你的设备名的地方，如果你有多个设备，可以记录在这里

#### DataPath

存储模板图片的相对路径，默认，不需要修改

#### Who

填写你的育成配置的代号，默认Default

#### 配置代号(Default, Sky, Skii, ...)

预设育成参数，可以储存多个配置，Who项就是填写这些代号的，可以自己建立自己的预设参数，结构需要一致
- ImportantRace:预设比赛，在该列表中的比赛优先度极高，会使脚本跳过读取训练加成的阶段，直接参加该回合相应比赛
  - 格式为{'你想要参加的比赛名':你想要参加的比赛的回合数,'下一个你想要参加的比赛名':下一个你想要参加的比赛的回合数}
- ValidRace:预设比赛，在该列表中的比赛是高价值比赛，在其他操作收益中等时就会参加比赛
  - 同上
- CommonRace:预设比赛，在该列表中的比赛是可选比赛，在其他操作收益很低时会参加比赛
  - 同上
- Speed/Stamina/Power:对应育成阶段应该达到的属性值
  - 正确理解：脚本会根据你设置的属性而努力在对应回合达到设定的属性值，而高于设定的属性值则会抑制脚本选择相应训练，你的属性目标不应该过高或过低；这一设计更多的是针对继承而设计的；例如，若你的种马为你提供了一个高额的速度加成，你可以在两次继承时每次都获取到70的速度提升，那么你的属性目标就应该将`第二年继承前`的值调低，`第二年夏季合宿前`的值调高，同时压缩`第二年继承前`之前的属性目标值
- Will/Intell:对应属性的参考属性值，不修改，除非你有训练根性或智力的需求，但是对该值的修改对脚本的影响不大，因此不建议修改

### 使用姿势与心态

脚本运行期间，你的手机设备不应该被以任何形式打断， **请不要** 在脚本运行时帮助脚本点击任何操作，请确保你的设备 **不会** 由于电话/消息/...在内的一系列因素使得手机出现切屏或弹出弹窗的情况

脚本完成一轮运行，时长预期在2小时左右，在此期间，你不应该操作你的手机，一切让脚本自动运行

脚本运行时，在有些地方，为了确保操作的有效性，会出现反复执行同一操作的情况，这属于正常现象，请不要误认为是脚本bug，除非该重复性行为重复次数大于20次，那么这时就应该是bug了

由于尚不明确的原因，脚本运行对CPU负担比较大，如果你对电脑配置没有信心，不建议在运行脚本时使用电脑，特别是运行其他高性能的程序

**正确使用姿势：早上起来，在去上学/上班前启动脚本，当你中午休息时，脚本就已经自动完成了运行；然后在你午休结束时，再次挂上脚本，等下午放学/下班回来，脚本又完成一轮运行；同理，晚上与睡觉都可以如此**

### 调试与bug

#### 目前已知的bug

- 在外出遇到抓娃娃事件时，可能会出现问题 | 目前已进行修复，但未知是否有效
- 网络连接出现问题、弹出`重试`弹窗时，无法识别，会导致脚本卡住 | 由于此种情况很少见，因此收集不到数据无法进行修复
- 如果在最后一回合战败，无法识别`再次挑战`弹窗 | 懒
- 使用远程adb连接时，手机截屏无法传输到电脑 | 原理不明，无从下手
- 有概率会在切换回合时识别错误，导致脚本提前判定进入下一回合，从而卡死 | 已进行修复，但未知是否有效

#### 调试手法

脚本运行时随时都有概率由于一些仍潜藏在阴影中bug所中断，或者被手动中断，因此会存在从育成到一半的中途启动脚本继续培育的情景，因此脚本提供从xx回合开始继续育成的功能

若脚本在运行途中不可避免的中断，你可以通过如下命令从指定回合开始运行脚本
```
python main.py xx
```

其中xx为回合数

**注意** ，这个回合数应为当前所处的回合、或接下来即将进入的回合；例如你的脚本中断在了第30与31回合的中间，你输入的回合数应该是31；而如果你的脚本中断在了第31回合读取训练的时候，那么你应该输入的回合数就是31

*特别注意，从中断状态启动脚本时，无需调整手机界面，只要是育成过程中出现的页面，脚本都可以识别 (除了一种情况，当你中断在 **选择比赛** 与 **即将参赛** 的页面时，脚本会因为bug而无法识别，请手动点击`返回`，回到育成界面再启动脚本)*

#### 回合数与目标赛事命名规则

回合数范围为[0,79]，其中0代表进入育成前；1~78对应第一年1月前半到URA决赛之间的每一个回合，例如24为第一年12月后半、35为第二年6月前半、73为URA预赛前的训练回合；大于78代表育成结束

比赛名称即为比赛所在回合的回合数，例如`皋月赏`的比赛名即为`31`，在`config.yaml`中应该填写{'31':31}；由此可见，这套比赛系统的兼容性很差，没有考虑同一回合不同比赛的情况，并且请不要轻易添加其他回合的比赛，因为这些回合比赛的识别材料在`source/data`中并不存在

